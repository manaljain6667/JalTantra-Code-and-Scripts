$title a Jaltantra model
Sets
    nodes   /1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35,
    36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
    71, 72, 73, 74, 75, 76, 77, 78 /
    pipes  /1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12/
    src(nodes) /1/;
alias (src,srcs);
alias (nodes,j) ;
alias (nodes,j1);
Set arcs(nodes,j) /2.7, 3.53, 4.11, 5.41, 6.1, 7.40, 8.29, 9.46, 10.32, 11.8, 12.24, 13.5, 14.3, 15.33, 16.59 , 17.29 , 18.43 , 19.22 , 20.30 , 21.26 , 22.1  , 23.36 ,
24.19 , 25.52 , 26.12 , 27.69 , 28.49,  29.60, 30.56 , 31.28 , 32.47 , 33.55 , 34.62 , 35.51 , 36.20 , 37.15 , 38.3  , 39.24 , 40.16 , 41.17 ,
42.41 , 43.7  , 44.77 , 45.74 , 46.28 , 47.26 , 48.66 , 49.59 , 50.39 , 51.5  , 52.35 , 53.4  , 54.14 , 55.36 ,56.22 ,57.23 ,58.57 ,59.33 ,60.37 ,
61.70 ,62.64 ,63.73 ,64.78 ,65.75 ,66.77 ,67.71 ,68.52 ,69.61 ,70.58 ,71.75 ,72.34 ,73.44 ,74.26 ,75.27 ,76.38 ,77.68 ,78.14 ,78.38 ,59.37 ,5.42 ,
3.11 ,7.60 ,31.58 ,2.14 ,40.43 ,70.36 ,45.24 ,16.60 ,37.33 ,77.63 ,34.76 ,45.32 ,10.61 ,8.17 ,54.18 ,50.22 ,78.54 ,34.54 ,58.49 ,1.30  /

Parameters
    Len(nodes,j) /2    .7    86.33, 3    .53    63.9, 4    .11    49.8, 5    .41    32.97, 6    .1    8.133, 7    .40    66.2, 8    .29    32.63, 9    .46    15.57,
10    .32    38.67, 11    .8    22.57, 12    .24    32.84, 13    .5    9.716, 14    .3    81.12, 15    .33    27.61, 16    .59    70.99,
17    .29    37.48, 18    .43    67.27, 19    .22    12.6, 20    .30    20.26, 21    .26    30.14, 22    .1    3.461, 23    .36    5.625,
24    .19    25.23, 25    .52    71.95, 26    .12    15.33, 27    .69    71.67, 28    .49    68.54, 29    .60    33.92, 30    .56    2.016,
31    .28    33.31, 32    .47    15.53, 33    .55    45.43, 34    .62    63.8, 35    .51    77.88, 36    .20    20.62, 37    .15    8.929,
38    .3    118, 39    .24    10.45, 40    .16    43.4, 41    .17    27.91, 42    .41    29.45, 43    .7    179.9, 44    .77    54.01,
45    .74    34.01, 46    .28    54.68, 47    .26    18.3, 48    .66    90.42, 49    .59    19.27, 50    .39    27.45, 51    .5    43.66,
52    .35    89.42, 53    .4    22.31, 54    .14    135.2, 55    .36    23.18, 56    .22    6.525, 57    .23    42.65, 58    .57    42.54,
59    .33    63.29, 60    .37    34.33, 61    .70    48.7, 62    .64    26.76, 63    .73    53.62, 64    .78    27.45, 65    .75    92.65,
66    .77    93.53, 67    .71    99.45, 68    .52    29.57, 69    .61    116.4, 70    .58    24.39, 71    .75    112.2, 72    .34    90.79,
73    .44    145.8, 74    .26    15.23, 75    .27    173.4, 76    .38    121.8, 77    .68    120.7, 78    .14    106.4, 78    .38    171.9,
59    .37    87.03, 5     .42    47.63, 3     .11    104.9, 7     .60    147.8, 31    .58    86.82, 2     .14    100.5, 40    .43    229.6, 
70    .36    92.25, 45    .24    57.6, 16    .60    120.7, 37    .33    36.37, 77    .63    183, 34    .76    223.5, 45    .32    66.48, 
10    .61    67.23, 8     .17    63.52, 54    .18    228.2, 50    .22    64.81, 78    .54    174.3, 34    .54    244.8, 58    .49    95.46,1     .30    10.82  /
    E(nodes) /1   45, 2   16, 3   11, 4   15, 5   17, 6   21, 7   17, 8   13, 9   20, 10   14, 11   15, 12   15, 13   18, 14   16, 15   18, 
16   17, 17   18, 18   13, 19   18, 20   17, 21   21, 22   22, 23   13, 24   6, 25   16, 26   11, 27   16, 28   16, 29   8, 30   19, 31   15,
32   17, 33   14, 34   13, 35   11, 36   13, 37   13, 38   17, 39   14, 40   16, 41   17, 42   23, 43   11, 44   20, 45   14, 46   9, 47   20,
48   17, 49   14, 50   21, 51   17, 52   11, 53   16, 54   13, 55   19, 56   11, 57   15, 58   17, 59   12, 60   13, 61   11, 62   15, 63   18,
64   17, 65   12, 66   19, 67   23, 68   14, 69   13, 70   21, 71   12, 72   16, 73   8, 74   18, 75   17, 76   14,77   16, 78   13 /
    P(nodes) /1   0, 2   0, 3   0, 4   0, 5   0, 6   0, 7   0, 8   0, 9   0, 10   0, 11   0, 12   0, 13   0, 14   0, 15   0, 16   0, 17   0, 
18   0, 19   0, 20   0, 21   0, 22   0, 23   0, 24   0, 25   0, 26   0, 27   0, 28   0, 29   0, 30   0, 31   0, 32   0, 33   0, 34   0, 35   0,
36   0, 37   0, 38   0, 39   0, 40   0, 41   0, 42   0, 43   0, 44   0, 45   0, 46   0, 47   0, 48   0, 49   0, 50   0, 51   0, 52   0, 53   0,
54   0, 55   0, 56   0, 57   0, 58   0, 59   0, 60   0, 61   0, 62   0, 63   0, 64   0, 65   0, 66   0, 67   0, 68   0, 69   0, 70   0, 71   0, 
72   0, 73   0, 74   0, 75   0, 76   0, 77   0, 78   0  /
    D(nodes) /1   -492.71423, 2   0.0402, 3   0.0791, 4   0.0155, 5   0.0288, 6   0.00175, 7   0.103, 8   0.0255, 9   0.00335, 10   0.0228,
11   0.0381, 12   0.0104, 13   0.00209, 14   0.091, 15   0.00786, 16   0.0506, 17   0.0277, 18   0.0635, 19   0.00813, 20   0.00879, 21   0.00648,
22   0.0188, 23   0.0104, 24   0.0271, 25   0.0155, 26   0.017, 27   0.0527, 28   0.0337, 29   0.0224, 30   0.00712, 31   0.0258, 32   0.0259,
33   0.0371, 34   0.134, 35   0.036, 36   0.0305, 37   0.0358, 38   0.0885, 39   0.00815, 40   0.0729, 41   0.0194, 42   0.0166, 43   0.102,
44   0.0429, 45   0.034, 46   0.0151, 47   0.00727, 48   0.0194, 49   0.0394, 50   0.0198, 51   0.0261, 52   0.0411, 53   0.0185, 54   0.168,
55   0.0148, 56   0.00184, 57   0.0183, 58   0.0536, 59   0.0517, 60   0.0724, 61   0.0499, 62   0, 63   0.17, 64   0.17, 65   0.17, 66   0.17,
67   0.199, 68   0.301, 69   0.376, 70   0.331, 71   0.254, 72   0.109, 73   0.239, 74   0.0591, 75   122, 76   122, 77   122, 78   122  /
    dis(pipes) /1   63, 2   75, 3   90, 4   110, 5   125, 6   140, 7   160, 8   180, 9   200, 10   250, 11   280, 12   315 /
    C(pipes) /1   116, 2   172, 3   231, 4   340, 5   461, 6   576, 7   750, 8   945, 9   1113, 10   1762, 11   2210, 12   2794 /
    R(pipes) /1   140, 2   140, 3   140, 4   140, 5   140, 6   140, 7   140, 8   140, 9   140, 10   140, 11   140, 12   140 /
    Source(src)   /1 1/;


Scalar omega  /10.68/;
Scalar bnd ;
Scalar qm;
Scalar q_M;

bnd = sum(src,D(src));
q_M=-bnd;
qm=0;

Variable l(nodes,j,pipes); 
l.lo(nodes,j,pipes)= EPS;

Variable q1(nodes,j);
q1.lo(nodes,j)=qm;
q1.up(nodes,j)=q_M;

Variable q2(nodes,j);
q2.lo(nodes,j)=qm;
q2.up(nodes,j)=q_M;

Variables z;

Variable h(nodes);

Equations cost "objective function",bound1(nodes,j,pipes),cons1(nodes),cons2(nodes),cons3(nodes,j),cons5(src), cons4(nodes,j), cons6(nodes,j) ;

cost..  z=e=sum(arcs(nodes,j),sum(pipes,l(arcs,pipes)*c(pipes)));

bound1(nodes,j,pipes)$arcs(nodes,j).. l(nodes,j,pipes) =l= Len(nodes,j);
cons1(nodes).. sum(arcs(j,nodes),(q1(arcs)-q2(arcs))) =e= sum(arcs(nodes,j),(q1(arcs)-q2(arcs))) + D(nodes);
cons2(nodes).. h(nodes) =g= E(nodes) + P(nodes);
cons3(arcs(nodes,j)).. h(nodes)-h(j)=e=sum(pipes,(((q1(arcs)*0.001)**1.852 - (q2(arcs)*0.001)**1.852)*omega*l(arcs,pipes))/((R(pipes)**1.852)*(dis(pipes)/1000)**4.87));
cons4(arcs(nodes,j)).. sum(pipes,l(arcs,pipes)) =e=Len(arcs);
cons5(src)..  h(src)=e= sum(srcs,E(srcs));
cons6(arcs(nodes,j)).. q1(arcs)*q2(arcs) =l= q_M*qm;
model m1  /all/  ;
solve m1 using dnlp minimizing z ;
